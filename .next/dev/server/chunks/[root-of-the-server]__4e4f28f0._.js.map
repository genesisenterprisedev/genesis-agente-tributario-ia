{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///media/elso/dev/projects/genesisEnterprise/genesis.specific/frontend/genesis-agente-tributario-ia/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\n\nexport async function POST(request: Request) {\n    try {\n        const body = await request.json();\n        const { prompt, model } = body;\n\n        // Use server-side only environment variable (without NEXT_PUBLIC_ prefix)\n        const apiKey = process.env.OPENROUTER_API_KEY || process.env.NEXT_PUBLIC_OPENROUTER_API_KEY;\n\n        if (!apiKey) {\n            console.error('[API Route] OPENROUTER_API_KEY not configured in environment');\n            return NextResponse.json({ error: 'API Key not configured' }, { status: 500 });\n        }\n\n        const OPENROUTER_API_BASE = process.env.NEXT_PUBLIC_OPENROUTER_API_URL || \"https://openrouter.ai\";\n        const OPENROUTER_API_URL = `${OPENROUTER_API_BASE.replace(/\\/$/, \"\")}/api/v1/chat/completions`;\n\n        console.log('[API Route] Making request to OpenRouter:', OPENROUTER_API_URL);\n        console.log('[API Route] Using model:', model || \"openai/gpt-4o-mini\");\n\n        // Add timeout to prevent hanging requests\n        const controller = new AbortController();\n        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n\n        try {\n            const response = await fetch(OPENROUTER_API_URL, {\n                method: \"POST\",\n                headers: {\n                    \"Content-Type\": \"application/json\",\n                    \"Authorization\": `Bearer ${apiKey}`,\n                    \"HTTP-Referer\": request.headers.get(\"origin\") || \"http://localhost:3000\",\n                    \"X-Title\": \"Genesis Agente Tributario\",\n                },\n                body: JSON.stringify({\n                    model: model || \"openai/gpt-4o-mini\",\n                    messages: [{ role: \"user\", content: prompt }],\n                }),\n                signal: controller.signal,\n            });\n\n            clearTimeout(timeoutId);\n\n            if (!response.ok) {\n                const errorText = await response.text();\n                console.error(\"[API Route] OpenRouter API Error:\", response.status, errorText);\n                return NextResponse.json({\n                    error: `OpenRouter error: ${response.status} - ${errorText}`\n                }, { status: response.status });\n            }\n\n            const data = await response.json();\n            console.log('[API Route] Successfully received response from OpenRouter');\n            return NextResponse.json(data);\n\n        } catch (fetchError: any) {\n            clearTimeout(timeoutId);\n\n            if (fetchError.name === 'AbortError') {\n                console.error('[API Route] Request timeout after 30 seconds');\n                return NextResponse.json({\n                    error: 'Request timeout - OpenRouter took too long to respond'\n                }, { status: 504 });\n            }\n\n            console.error('[API] Fetch error calling OpenRouter:', fetchError);\n            throw fetchError;\n        }\n\n    } catch (error: any) {\n        console.error(\"[API] Route Error:\", error);\n\n        // Determina se é um erro de configuração ou de rede\n        let errorMessage = error.message || \"Internal Server Error\";\n        let statusCode = 500;\n\n        if (errorMessage.includes(\"API Key not configured\")) {\n            statusCode = 401; // Unauthorized\n        } else if (errorMessage.includes(\"fetch failed\")) {\n            errorMessage = \"Falha na conexão com OpenRouter (DNS ou Rede). Verifique sua internet.\";\n            statusCode = 502; // Bad Gateway\n        }\n\n        return NextResponse.json({\n            error: errorMessage,\n            details: error.cause ? String(error.cause) : undefined\n        }, { status: statusCode });\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAgB;IACvC,IAAI;QACA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG;QAE1B,0EAA0E;QAC1E,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB,IAAI,QAAQ,GAAG,CAAC,8BAA8B;QAE3F,IAAI,CAAC,QAAQ;YACT,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,MAAM,sBAAsB,6DAA8C;QAC1E,MAAM,qBAAqB,GAAG,oBAAoB,OAAO,CAAC,OAAO,IAAI,wBAAwB,CAAC;QAE9F,QAAQ,GAAG,CAAC,6CAA6C;QACzD,QAAQ,GAAG,CAAC,4BAA4B,SAAS;QAEjD,0CAA0C;QAC1C,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI,QAAQ,oBAAoB;QAEnF,IAAI;YACA,MAAM,WAAW,MAAM,MAAM,oBAAoB;gBAC7C,QAAQ;gBACR,SAAS;oBACL,gBAAgB;oBAChB,iBAAiB,CAAC,OAAO,EAAE,QAAQ;oBACnC,gBAAgB,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;oBACjD,WAAW;gBACf;gBACA,MAAM,KAAK,SAAS,CAAC;oBACjB,OAAO,SAAS;oBAChB,UAAU;wBAAC;4BAAE,MAAM;4BAAQ,SAAS;wBAAO;qBAAE;gBACjD;gBACA,QAAQ,WAAW,MAAM;YAC7B;YAEA,aAAa;YAEb,IAAI,CAAC,SAAS,EAAE,EAAE;gBACd,MAAM,YAAY,MAAM,SAAS,IAAI;gBACrC,QAAQ,KAAK,CAAC,qCAAqC,SAAS,MAAM,EAAE;gBACpE,OAAO,gJAAY,CAAC,IAAI,CAAC;oBACrB,OAAO,CAAC,kBAAkB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,WAAW;gBAChE,GAAG;oBAAE,QAAQ,SAAS,MAAM;gBAAC;YACjC;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;QAE7B,EAAE,OAAO,YAAiB;YACtB,aAAa;YAEb,IAAI,WAAW,IAAI,KAAK,cAAc;gBAClC,QAAQ,KAAK,CAAC;gBACd,OAAO,gJAAY,CAAC,IAAI,CAAC;oBACrB,OAAO;gBACX,GAAG;oBAAE,QAAQ;gBAAI;YACrB;YAEA,QAAQ,KAAK,CAAC,yCAAyC;YACvD,MAAM;QACV;IAEJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,sBAAsB;QAEpC,oDAAoD;QACpD,IAAI,eAAe,MAAM,OAAO,IAAI;QACpC,IAAI,aAAa;QAEjB,IAAI,aAAa,QAAQ,CAAC,2BAA2B;YACjD,aAAa,KAAK,eAAe;QACrC,OAAO,IAAI,aAAa,QAAQ,CAAC,iBAAiB;YAC9C,eAAe;YACf,aAAa,KAAK,cAAc;QACpC;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,OAAO;YACP,SAAS,MAAM,KAAK,GAAG,OAAO,MAAM,KAAK,IAAI;QACjD,GAAG;YAAE,QAAQ;QAAW;IAC5B;AACJ"}}]
}