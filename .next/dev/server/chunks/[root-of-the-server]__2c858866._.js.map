{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///media/elso/dev/projects/genesisEnterprise/genesis.specific/frontend/genesis-agente-tributario-ia/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { Resend } from \"resend\";\n\nconst resend = process.env.NEXT_PUBLIC_RESEND_API_KEY\n  ? new Resend(process.env.NEXT_PUBLIC_RESEND_API_KEY)\n  : null;\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { prompt, model } = body;\n\n    // Use server-side only environment variable (without NEXT_PUBLIC_ prefix)\n    const apiKey =\n      process.env.OPENROUTER_API_KEY ||\n      process.env.NEXT_PUBLIC_OPENROUTER_API_KEY;\n\n    if (!apiKey) {\n      console.error(\n        \"[API Route] OPENROUTER_API_KEY not configured in environment\"\n      );\n      return NextResponse.json(\n        { error: \"API Key not configured\" },\n        { status: 500 }\n      );\n    }\n\n    const OPENROUTER_API_BASE =\n      process.env.NEXT_PUBLIC_OPENROUTER_API_URL || \"https://openrouter.ai\";\n    const OPENROUTER_API_URL = `${OPENROUTER_API_BASE.replace(/\\/$/, \"\")}/api/v1/chat/completions`;\n\n    console.log(\n      \"[API Route] Making request to OpenRouter:\",\n      OPENROUTER_API_URL\n    );\n    console.log(\"[API Route] Using model:\", model || \"openai/gpt-4o-mini\");\n\n    // Add timeout to prevent hanging requests\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n\n    try {\n      const response = await fetch(OPENROUTER_API_URL, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${apiKey}`,\n          \"HTTP-Referer\":\n            request.headers.get(\"origin\") || \"http://localhost:3000\",\n          \"X-Title\": \"Genesis Agente Tributario\",\n        },\n        body: JSON.stringify({\n          model: model || \"openai/gpt-4o-mini\",\n          messages: [{ role: \"user\", content: prompt }],\n        }),\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        const rawErrorText = await response.text();\n        console.error(\n          \"[API Route] OpenRouter API Error:\",\n          response.status,\n          rawErrorText\n        );\n\n        // Tenta extrair mensagem do provider\n        let providerMessage = rawErrorText;\n        try {\n          const parsed = JSON.parse(rawErrorText);\n          providerMessage =\n            parsed?.error?.message || rawErrorText || \"Unknown provider error\";\n        } catch {\n          // mantém rawErrorText\n        }\n\n        // Envia alerta de infra para qualquer erro do provider em produção\n        if (resend && process.env.NODE_ENV === \"production\") {\n          try {\n            await resend.emails.send({\n              from: \"Genesis AI Infra <onboarding@resend.dev>\",\n              to: [\"infra.genesisplatform@gmail.com\"],\n              subject: `[Genesis IA] OpenRouter error em /api/chat - status ${response.status}`,\n              text: [\n                `Time: ${new Date().toISOString()}`,\n                \"Endpoint: /api/chat\",\n                `Status: ${response.status}`,\n                `Model: ${model || \"openai/gpt-4o-mini\"}`,\n                `Provider message: ${providerMessage}`,\n              ].join(\"\\n\"),\n            });\n          } catch (emailError) {\n            console.error(\n              \"[API Route] Failed to send LLM error alert email:\",\n              emailError\n            );\n          }\n        }\n\n        return NextResponse.json(\n          {\n            error: `OpenRouter error: ${response.status} - ${providerMessage}`,\n          },\n          { status: response.status }\n        );\n      }\n\n      const data = await response.json();\n      console.log(\"[API Route] Successfully received response from OpenRouter\");\n      return NextResponse.json(data);\n    } catch (fetchError: any) {\n      clearTimeout(timeoutId);\n\n      if (fetchError.name === \"AbortError\") {\n        console.error(\"[API Route] Request timeout after 30 seconds\");\n        return NextResponse.json(\n          {\n            error: \"Request timeout - OpenRouter took too long to respond\",\n          },\n          { status: 504 }\n        );\n      }\n\n      console.error(\"[API] Fetch error calling OpenRouter:\", fetchError);\n      throw fetchError;\n    }\n  } catch (error: any) {\n    console.error(\"[API] Route Error:\", error);\n\n    // Determina se é um erro de configuração ou de rede\n    let errorMessage = error.message || \"Internal Server Error\";\n    let statusCode = 500;\n\n    if (errorMessage.includes(\"API Key not configured\")) {\n      statusCode = 401; // Unauthorized\n    } else if (errorMessage.includes(\"fetch failed\")) {\n      errorMessage =\n        \"Falha na conexão com OpenRouter (DNS ou Rede). Verifique sua internet.\";\n      statusCode = 502; // Bad Gateway\n    }\n\n    return NextResponse.json(\n      {\n        error: errorMessage,\n        details: error.cause ? String(error.cause) : undefined,\n      },\n      { status: statusCode }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,SAAS,uCACX,IAAI,oJAAM,6EACV;AAEG,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,GAAG;QAE1B,0EAA0E;QAC1E,MAAM,SACJ,QAAQ,GAAG,CAAC,kBAAkB,IAC9B,QAAQ,GAAG,CAAC,8BAA8B;QAE5C,IAAI,CAAC,QAAQ;YACX,QAAQ,KAAK,CACX;YAEF,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyB,GAClC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,sBACJ,6DAA8C;QAChD,MAAM,qBAAqB,GAAG,oBAAoB,OAAO,CAAC,OAAO,IAAI,wBAAwB,CAAC;QAE9F,QAAQ,GAAG,CACT,6CACA;QAEF,QAAQ,GAAG,CAAC,4BAA4B,SAAS;QAEjD,0CAA0C;QAC1C,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI,QAAQ,oBAAoB;QAEnF,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,oBAAoB;gBAC/C,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe,CAAC,OAAO,EAAE,QAAQ;oBACjC,gBACE,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;oBACnC,WAAW;gBACb;gBACA,MAAM,KAAK,SAAS,CAAC;oBACnB,OAAO,SAAS;oBAChB,UAAU;wBAAC;4BAAE,MAAM;4BAAQ,SAAS;wBAAO;qBAAE;gBAC/C;gBACA,QAAQ,WAAW,MAAM;YAC3B;YAEA,aAAa;YAEb,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,eAAe,MAAM,SAAS,IAAI;gBACxC,QAAQ,KAAK,CACX,qCACA,SAAS,MAAM,EACf;gBAGF,qCAAqC;gBACrC,IAAI,kBAAkB;gBACtB,IAAI;oBACF,MAAM,SAAS,KAAK,KAAK,CAAC;oBAC1B,kBACE,QAAQ,OAAO,WAAW,gBAAgB;gBAC9C,EAAE,OAAM;gBACN,sBAAsB;gBACxB;gBAEA,mEAAmE;gBACnE;;gBAsBA,OAAO,gJAAY,CAAC,IAAI,CACtB;oBACE,OAAO,CAAC,kBAAkB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,iBAAiB;gBACpE,GACA;oBAAE,QAAQ,SAAS,MAAM;gBAAC;YAE9B;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;QAC3B,EAAE,OAAO,YAAiB;YACxB,aAAa;YAEb,IAAI,WAAW,IAAI,KAAK,cAAc;gBACpC,QAAQ,KAAK,CAAC;gBACd,OAAO,gJAAY,CAAC,IAAI,CACtB;oBACE,OAAO;gBACT,GACA;oBAAE,QAAQ;gBAAI;YAElB;YAEA,QAAQ,KAAK,CAAC,yCAAyC;YACvD,MAAM;QACR;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,sBAAsB;QAEpC,oDAAoD;QACpD,IAAI,eAAe,MAAM,OAAO,IAAI;QACpC,IAAI,aAAa;QAEjB,IAAI,aAAa,QAAQ,CAAC,2BAA2B;YACnD,aAAa,KAAK,eAAe;QACnC,OAAO,IAAI,aAAa,QAAQ,CAAC,iBAAiB;YAChD,eACE;YACF,aAAa,KAAK,cAAc;QAClC;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,MAAM,KAAK,GAAG,OAAO,MAAM,KAAK,IAAI;QAC/C,GACA;YAAE,QAAQ;QAAW;IAEzB;AACF"}}]
}