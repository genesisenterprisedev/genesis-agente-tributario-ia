{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///media/elso/dev/projects/genesisEnterprise/genesis.specific/frontend/genesis-agente-tributario-ia/app/api/embed/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { Resend } from \"resend\";\n\nconst resend = process.env.NEXT_PUBLIC_RESEND_API_KEY\n  ? new Resend(process.env.NEXT_PUBLIC_RESEND_API_KEY)\n  : null;\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const { text, texts } = body as { text?: string; texts?: string[] };\n\n    let inputs: string[] = [];\n\n    if (Array.isArray(texts) && texts.length > 0) {\n      inputs = texts.filter(\n        (t) => typeof t === \"string\" && t.trim().length > 0\n      );\n    } else if (typeof text === \"string\" && text.trim().length > 0) {\n      inputs = [text];\n    }\n\n    if (inputs.length === 0) {\n      return NextResponse.json(\n        { error: \"Text or texts are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Usar OpenRouter para gerar embeddings (mais consistente com a configuração atual)\n    const openrouterKey = process.env.OPENROUTER_API_KEY;\n\n    if (!openrouterKey) {\n      return NextResponse.json(\n        { error: \"OpenRouter API key not configured\" },\n        { status: 500 }\n      );\n    }\n\n    const response = await fetch(\"https://openrouter.ai/api/v1/embeddings\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${openrouterKey}`,\n        \"HTTP-Referer\": \"https://genesis-agente-tributario-ia.vercel.app\",\n        \"X-Title\": \"Genesis Agente Tributário IA\",\n      },\n      body: JSON.stringify({\n        model: \"text-embedding-ada-002\",\n        input: inputs,\n      }),\n    });\n\n    if (!response.ok) {\n      const error = (await response.json().catch(() => ({}))) as any;\n\n      // Envia alerta de infra para qualquer erro do provider em produção\n      if (resend && process.env.NODE_ENV === \"production\") {\n        try {\n          await resend.emails.send({\n            from: \"Genesis AI Infra <onboarding@resend.dev>\",\n            to: [\"infra.genesisplatform@gmail.com\"],\n            subject: `[Genesis IA] OpenRouter error em /api/embed - status ${response.status}`,\n            text: [\n              `Time: ${new Date().toISOString()}`,\n              \"Endpoint: /api/embed\",\n              `Status: ${response.status}`,\n              `Provider message: ${\n                error?.error?.message || \"Unknown provider error\"\n              }`,\n            ].join(\"\\n\"),\n          });\n        } catch (emailError) {\n          console.error(\"Failed to send LLM error alert email:\", emailError);\n        }\n      }\n\n      if (response.status !== 402) {\n        // Para erros diferentes de 402, ainda logamos no console para debug\n        console.error(\"OpenAI API error:\", error);\n      }\n\n      return NextResponse.json(\n        { error: \"Failed to generate embedding\" },\n        { status: response.status }\n      );\n    }\n\n    const data = await response.json();\n    const embeddings = Array.isArray(data?.data)\n      ? data.data.map((item: any) => item.embedding)\n      : [];\n\n    if (!embeddings.length) {\n      return NextResponse.json(\n        { error: \"No embeddings returned from provider\" },\n        { status: 500 }\n      );\n    }\n\n    // Compat: se a chamada antiga enviar apenas { text }, ainda devolvemos `embedding`\n    const result: any = { embeddings };\n    if (!texts && inputs.length === 1 && embeddings[0]) {\n      result.embedding = embeddings[0];\n    }\n\n    return NextResponse.json(result);\n  } catch (error: any) {\n    console.error(\"Embedding generation error:\", error);\n    return NextResponse.json(\n      { error: error?.message || \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,SAAS,uCACX,IAAI,oJAAM,6EACV;AAEG,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG;QAExB,IAAI,SAAmB,EAAE;QAEzB,IAAI,MAAM,OAAO,CAAC,UAAU,MAAM,MAAM,GAAG,GAAG;YAC5C,SAAS,MAAM,MAAM,CACnB,CAAC,IAAM,OAAO,MAAM,YAAY,EAAE,IAAI,GAAG,MAAM,GAAG;QAEtD,OAAO,IAAI,OAAO,SAAS,YAAY,KAAK,IAAI,GAAG,MAAM,GAAG,GAAG;YAC7D,SAAS;gBAAC;aAAK;QACjB;QAEA,IAAI,OAAO,MAAM,KAAK,GAAG;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA,oFAAoF;QACpF,MAAM,gBAAgB,QAAQ,GAAG,CAAC,kBAAkB;QAEpD,IAAI,CAAC,eAAe;YAClB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAoC,GAC7C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,WAAW,MAAM,MAAM,2CAA2C;YACtE,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,eAAe,CAAC,OAAO,EAAE,eAAe;gBACxC,gBAAgB;gBAChB,WAAW;YACb;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB,OAAO;gBACP,OAAO;YACT;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,QAAS,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;YAEpD,mEAAmE;YACnE;;YAoBA,IAAI,SAAS,MAAM,KAAK,KAAK;gBAC3B,oEAAoE;gBACpE,QAAQ,KAAK,CAAC,qBAAqB;YACrC;YAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ,SAAS,MAAM;YAAC;QAE9B;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,MAAM,aAAa,MAAM,OAAO,CAAC,MAAM,QACnC,KAAK,IAAI,CAAC,GAAG,CAAC,CAAC,OAAc,KAAK,SAAS,IAC3C,EAAE;QAEN,IAAI,CAAC,WAAW,MAAM,EAAE;YACtB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAuC,GAChD;gBAAE,QAAQ;YAAI;QAElB;QAEA,mFAAmF;QACnF,MAAM,SAAc;YAAE;QAAW;QACjC,IAAI,CAAC,SAAS,OAAO,MAAM,KAAK,KAAK,UAAU,CAAC,EAAE,EAAE;YAClD,OAAO,SAAS,GAAG,UAAU,CAAC,EAAE;QAClC;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,OAAO,WAAW;QAAwB,GACnD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}